<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISSI Stock Scraper Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e4;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 8px;
        }
        .stat-label { color: #888; font-size: 0.9rem; }
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .status-running { background: #22c55e33; color: #22c55e; }
        .status-idle { background: #64748b33; color: #94a3b8; }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, #00d4ff, #0099cc); color: #000; }
        .btn-secondary { background: linear-gradient(135deg, #7b2cbf, #5a189a); color: #fff; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); color: #fff; }
        .log-container {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .log-header h3 { color: #00d4ff; }
        #log-output {
            background: #0a0a0f;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        .log-entry { margin-bottom: 4px; }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-info { color: #64748b; }
        .stocks-section { margin-top: 30px; }
        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        .stock-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .stock-symbol { font-weight: 700; font-size: 1.1rem; color: #00d4ff; }
        .stock-price { font-size: 1.2rem; font-weight: 600; }
        .stock-change { font-size: 0.9rem; }
        .stock-change.positive { color: #22c55e; }
        .stock-change.negative { color: #ef4444; }
        .stock-name { color: #888; font-size: 0.85rem; margin-bottom: 8px; }
        .stock-meta { display: flex; gap: 15px; font-size: 0.8rem; color: #666; }
        .refresh-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #888;
            padding: 8px 16px;
        }
        .refresh-btn:hover { background: rgba(255,255,255,0.1); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulsing { animation: pulse 1.5s ease-in-out infinite; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä ISSI Stock Scraper Dashboard</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalStocks">-</div>
                <div class="stat-label">Total Scraped</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successCount">-</div>
                <div class="stat-label">Success</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorCount">-</div>
                <div class="stat-label">Errors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="historyRecords">-</div>
                <div class="stat-label">History Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="newsArticles">-</div>
                <div class="stat-label">News Articles</div>
            </div>
            <div class="stat-card">
                <div id="scrapeStatus" class="status-badge status-idle">Idle</div>
                <div class="stat-label" style="margin-top: 10px;">Scrape Status</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-primary" id="startScrape" onclick="startScrape()">
                üöÄ Start Scraping
            </button>
            <button class="btn-secondary" onclick="startScheduler()">
                ‚è∞ Start Scheduler (Hourly)
            </button>
            <button class="btn-danger" onclick="stopScheduler()">
                ‚èπÔ∏è Stop Scheduler
            </button>
            <button class="refresh-btn" onclick="refreshStats()">
                üîÑ Refresh
            </button>
        </div>

        <div class="log-container">
            <div class="log-header">
                <h3>üìù Activity Log</h3>
                <button class="refresh-btn" onclick="clearLog()">Clear</button>
            </div>
            <div id="log-output"></div>
        </div>

        <div class="stocks-section">
            <div class="log-header">
                <h3>üìà Recent Stocks</h3>
                <button class="refresh-btn" onclick="loadStocks()">Load Stocks</button>
            </div>
            <div class="stocks-grid" id="stocksGrid"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let autoRefresh;

        function log(message, type = 'info') {
            const output = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const classes = { success: 'log-success', error: 'log-error', info: 'log-info' };
            output.innerHTML += `<div class="log-entry ${classes[type] || ''}">[${time}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-output').innerHTML = '';
            log('Log cleared', 'info');
        }

        async function refreshStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const data = await res.json();
                
                document.getElementById('totalStocks').textContent = data.totalStocks || 0;
                document.getElementById('successCount').textContent = data.successCount || 0;
                document.getElementById('errorCount').textContent = data.errorCount || 0;
                document.getElementById('historyRecords').textContent = data.priceHistoryRecords || 0;
                document.getElementById('newsArticles').textContent = data.newsArticles || 0;
                
                const statusEl = document.getElementById('scrapeStatus');
                const startBtn = document.getElementById('startScrape');
                
                if (data.scrapeRunning) {
                    statusEl.textContent = 'Running...';
                    statusEl.className = 'status-badge status-running pulsing';
                    startBtn.disabled = true;
                } else {
                    statusEl.textContent = 'Idle';
                    statusEl.className = 'status-badge status-idle';
                    startBtn.disabled = false;
                }
            } catch (e) {
                log('Failed to fetch stats: ' + e.message, 'error');
            }
        }

        async function startScrape() {
            try {
                log('Starting scrape...', 'info');
                const res = await fetch(`${API_BASE}/api/scrape/trigger`, { method: 'POST' });
                const data = await res.json();
                log('Scrape started: ' + data.message, 'success');
                refreshStats();
                startAutoRefresh();
            } catch (e) {
                log('Failed to start scrape: ' + e.message, 'error');
            }
        }

        async function startScheduler() {
            try {
                const res = await fetch(`${API_BASE}/api/scheduler/start`, { method: 'POST' });
                const data = await res.json();
                log('Scheduler: ' + data.message, 'success');
            } catch (e) {
                log('Failed: ' + e.message, 'error');
            }
        }

        async function stopScheduler() {
            try {
                const res = await fetch(`${API_BASE}/api/scheduler/stop`, { method: 'POST' });
                const data = await res.json();
                log('Scheduler: ' + data.message, 'success');
            } catch (e) {
                log('Failed: ' + e.message, 'error');
            }
        }

        async function loadStocks() {
            try {
                const res = await fetch(`${API_BASE}/api/stocks?limit=20`);
                const data = await res.json();
                const grid = document.getElementById('stocksGrid');
                
                grid.innerHTML = data.data.map(stock => `
                    <div class="stock-card">
                        <div class="stock-header">
                            <span class="stock-symbol">${stock.symbol}</span>
                            <span class="stock-price">Rp ${(stock.price || 0).toLocaleString()}</span>
                        </div>
                        <div class="stock-name">${stock.name || '-'}</div>
                        <div class="stock-change ${(stock.changePercent || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(stock.changePercent || 0) >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(stock.changePercent || 0).toFixed(2)}%
                        </div>
                        <div class="stock-meta">
                            <span>MCap: ${stock.marketCap || '-'}</span>
                            <span>Vol: ${stock.volume || '-'}</span>
                        </div>
                    </div>
                `).join('');
                
                log(`Loaded ${data.data.length} stocks`, 'success');
            } catch (e) {
                log('Failed to load stocks: ' + e.message, 'error');
            }
        }

        function startAutoRefresh() {
            if (autoRefresh) clearInterval(autoRefresh);
            autoRefresh = setInterval(refreshStats, 5000);
        }

        // Initial load
        refreshStats();
        log('Dashboard initialized', 'info');
        setInterval(refreshStats, 10000);
    </script>
</body>
</html>
